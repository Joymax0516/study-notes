## å¼‚æ­¥ç¼–ç¨‹

å¤šçº¿ç¨‹å®ç°å¼‚æ­¥

å•çº¿ç¨‹ï¼šä¸€ä¸ªä»»åŠ¡ä»å¤´åˆ°ä½ç”±ä¸€ä¸ªçº¿ç¨‹å®Œæˆï¼Œåœ¨ä¸€ä¸ªä»»åŠ¡å®Œæˆä¹‹å‰ï¼Œä¸æ¥å—ç¬¬äºŒä¸ªä»»åŠ¡

å¤šçº¿ç¨‹ï¼šå°†ä¸€ä¸ªä»»åŠ¡æ‹†åˆ†æˆä¸åŒçš„é˜¶æ®µï¼Œå¹¶äº¤ç»™ä¸åŒçš„çº¿ç¨‹å¤„ç†



```C#
namespace demo111å¤šçº¿ç¨‹åŒæ­¥
{
  internal class Program
  {
     static void Main(string[] args)
     {
         Console.WriteLine("æ¬¢è¿å…‰ä¸´ï¼Œè¯·é—®éœ€è¦åƒä»€ä¹ˆ")ï¼›
         Person p = new Person();
         p.Food = Console.ReadLine();
         Console.WriteLine($"å¥½çš„{p.Name}å…ˆç”Ÿï¼Œè¯·ç§»åŠ¨åˆ°é…é¤åŒº");
         Thread th = new Thread(() =>{
            Console.WriteLine($"{p.Name}å…ˆç”Ÿï¼Œä½ ç‚¹çš„{p.Food}æ­£åœ¨å‡†å¤‡ä¸­ï¼Œè¯·ç¨å");
            Thread.Sleep(3000);
         });
       //æ‰§è¡Œé¡ºåºä¸ä¸€æ ·
       //ä¸æ˜¯ç«‹åˆ»å¼€å§‹çº¿ç¨‹æ‰§è¡Œçš„æ¼”ç¤ºï¼Œè€Œæ˜¯ç»™çº¿ç¨‹åšä¸€ä¸ªæ ‡è®°ï¼Œæˆ‘å·²ç»okäº†ï¼Œéšæ—¶å¯ä»¥è¢«cpuæ‰§è¡Œ
         th.Start();
        //1.è®©ç”¨æˆ·å»åšå…¶ä»–äº‹æƒ…
        //2.å½“é…é¤å®Œæˆæ—¶å€™ å›æ¥å–é¤
         Walk();
         WC();
         FindSeat();
         while(true)
         {
            if(th.ThreadState == ThreadState.Stopped)
            {
              Console.WriteLine($"{p.Name},æ‚¨ç‚¹çš„{p.Food}å·²ç»é…é¤å®Œæˆ");
              break;
            }
         }
       static void Walk()
       {
          Console.WriteLine("æˆ‘å»æºœè¾¾");
       }
       static void WC()
       {
          Console.WriteLine("å½“å‰å°¿æ€¥");
       }
       static void FindSeat()
       {
          Console.WriteLine("æ‰¾åº§ä½");
       }
     }
  }
  class Person
  {
     public string Name{get; set;}
     public string Food{get; set;}
  }
}
```





### å¤šçº¿ç¨‹ä¼ å‚

```C#
public static Program
{
  static void Main(string[] args)
  {
     int i = 10;
     Thread th = new Thread((o) =>{
        Thread.Sleep(2000);
        i = (int)o;  //è£…ç®± åœ¨å†…å­˜ä¸­ä¼šå¼€è¾Ÿæ–°ç©ºé—´ï¼Œä¸æ¨èï¼Œå› ä¸ºä¼šå‘ç”Ÿè£…ç®±
        Console.WriteLine(i);
     });
    //
     th.Start(i);
    //Thread.Sleep(1000); //ç¡çœ ä¸€ç§’ä¸­ï¼Œçº¿ç¨‹æ‰§è¡Œå®Œäº†ï¼Œå¯èƒ½iä¼šæ˜¯10ï¼Œè¿˜æ²¡æœ‰æ¥å¾—åŠå˜20ï¼›å¯ä»¥ç­‰å¾…å­çº¿ç¨‹æ‰§è¡Œå®Œï¼Œå†å»æ‰§è¡Œä¸»çº¿ç¨‹
    //è®©æˆ‘ä»¬çš„å­çº¿ç¨‹å»å µå¡æˆ‘ä»¬çš„ä¸»çº¿ç¨‹
     //th.Join();  //10
     i = 20;
  }
}
//20
```



### å¤šçº¿ç¨‹çš„ä¼˜å…ˆçº§

```C#
namespace demoå¤šçº¿ç¨‹çš„ä¼˜å…ˆçº§
{
  internal class Program
  {
      static void Main(string[] args)
      {
          int numberOne = 0;
          int numberTwo = 0;
          
          Thread th1 = new Thread(() => {
             while(true)
             {
                 numberOne++;
             }
          });
          Thread th2 = new Thread(() => {
             while(true)
             {
                 numberTwo++;
             }
          });
          th1.Priority = ThreadPriority.Highest;
          th2.Priority = ThreadPriotiry.Lowest;
          //å¯èƒ½ä¸åœ¨ä¸€ä¸ªcpuä¸Šï¼Œæ˜¯å¤šæ ¸cpuï¼Œåœ¨å•æ ¸cpuæ—¶ä»£ï¼Œè®¾ç½®ä¼˜å…ˆçº§æœ‰ç”¨ï¼Œå¤šæ ¸çš„æƒ…å†µä¸‹ï¼Œæ²¡æœ‰ç”¨ã€‚
          
          th1.Start();
          th2.Start();
          Console.WriteLine("numberOne=" + numberOne);
          Console.WirteLine("numberTwo=" + numberTwo);
      }
   }
}
```



### çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ

å‡ºç”Ÿåˆ°æ­»äº¡çš„5ç§çŠ¶æ€

```C#
namespace demo114
{
   internal class Program
   {
      //åˆ›å»ºäº†çº¿ç¨‹å¯¹è±¡ï¼Œä½†æ˜¯æ²¡æœ‰æ‰§è¡Œstart(), new Thread();çº¿ç¨‹å¯¹è±¡Start å‡ºç”Ÿ
     //è°ƒç”¨Startï¼Œå°†çº¿ç¨‹æ ‡è®°ä¸ºå¯æ‰§è¡ŒçŠ¶æ€
     //æ­£åœ¨æ‰§è¡ŒçŠ¶æ€
     //Join/Sleepæš‚åœï¼Œåªè¦åœ¨è¿‡ç¨‹ä¸­å›½çº¿ç¨‹è¢«æš‚åœäº†
     //ç»“æŸçŠ¶æ€ï¼š å®Œæˆå®Œæ•´æ‰§è¡Œäº†ä»£ç 
     Thread th = new Thread(() => {
       
     });
     th.IsBackground = true; //åªè¦æ‰€æœ‰çš„å‰å°çº¿ç¨‹ç»“æŸï¼Œæˆ‘å°±è‡ªåŠ¨ç»“æŸ
     th.Start();
     //çº¿ç¨‹ä¸­é’ˆå¯¹ç”Ÿå‘½å‘¨æœŸè®¾ç½®äº†ä¸€äº›ç›¸å…³çš„æ¦‚å¿µ
     //Aborted: ç»“æŸçº¿ç¨‹ï¼ˆéæ­£å¸¸ç»“æŸ)çº¿ç¨‹ï¼Œçº¿ç¨‹ä¸èƒ½å†è¿è¡Œäº†
     //Interrupt() æ‰“æ–­çº¿ç¨‹çš„æ‰§è¡Œï¼Œåç»­è¿˜å¯ä»¥ç»§ç»­æ‰§è¡Œ
     //AbortRequested:è¯·æ±‚ç»“æŸçº¿ç¨‹
     //BackGroundæ—¶å€™æ˜¯åå°çº¿ç¨‹
     //Runningæ­£åœ¨æ‰§è¡Œçš„çŠ¶æ€
     //Stoppedçº¿ç¨‹ç»“æŸçš„çŠ¶æ€
     //StopRequestedï¼šè¯·æ±‚çº¿ç¨‹ç»“æŸ
     //Suspendedï¼šçº¿ç¨‹æŒ‚èµ·ï¼ˆä¸æ¨èä½¿ç”¨ï¼‰é€ æˆæ­»é”
     //Unstartedï¼šå‡ºç”Ÿ
     //WaitSleepJoin Join/Sleepè°ƒç”¨è¿™ æš‚åœäº†çº¿ç¨‹
     Console.WriteLine(th.ThreadState == ThreadState.AbortRequested);
   }
}
```



```C#
Thread th = new Thread(()=>{
   for(int i = 0; i < 10; i++)
   {
      try{
        Console.WriteLine(i);
        Thread.Sleep(1000);
      } 
     catch(ThreadInterruptedException e){
        Console.WriteLine(e);
       
     }
     catch(ThreadAbortException e)
     {
        Console.WriteLine(e);
     }
   }
});
//åªè¦æˆ‘ä»¬çš„çº¿ç¨‹è®¾ç½®ä¸ºåå°çº¿ç¨‹ï¼Œåœ¨çº¿ç¨‹å¤„äºæ­£å¸¸çš„çŠ¶æ€ä¸‹ï¼ˆæ²¡æœ‰æš‚åœæˆ–è€…é˜»å¡çº¿ç¨‹ï¼‰ BackGround
//th.IsBackground = true; //åªè¦æ‰€æœ‰çš„å‰å°ï¼Œçº¿ç¨‹ç»“æŸäº† æˆ‘å°±è‡ªåŠ¨ç»“æŸ
Console.WriteLine(th.ThreadState); //åœ¨è°ƒç”¨çº¿ç¨‹ä¹‹å‰ æ‰“å°çŠ¶æ€

th.Start();
Thread.Sleep(3000);
Console.WriteLine(th.ThreadState); //åœ¨è°ƒç”¨çº¿ç¨‹ä¹‹å æ‰“å°çŠ¶æ€
//é€šè¿‡ä¸€ä¸ªè½®è¯¢ï¼Œæ¥ä¸æ–­åˆ¤æ–­å­çº¿ç¨‹çš„çŠ¶æ€ ä¸€æ—¦æš‚åœäº† å°±ç«‹é©¬æ‰“æ–­
while(true)
{
   if(th.ThreadState == ThreadState.WaitSleepJoin)
   {
     //æ‰“æ–­ä¸­æ­¢æˆ‘ä»¬çš„çº¿ç¨‹ï¼Œåç»­è¿˜å¯ä»¥æ­£å¸¸æ‰§è¡Œ
      th.Abort(); //éæ­£å¸¸ç»“æŸï¼Œæ‰“æ–­äº†å°±ä¸èƒ½å¼€å§‹äº†
      break;
   }
   Console.WriteLine(th.ThreadState);
  
}
```



### å¤šçº¿ç¨‹åŒæ­¥



CPUè§†è§’ï¼š

å¹¶å‘ï¼š ä¸€æ®µæ—¶é—´å†…ï¼ŒåŒæ—¶åšå¤šä»¶äº‹æƒ…ï¼Œ CPUæ¥å›åˆ‡æ¢ä»»åŠ¡

å¹¶è¡Œï¼šåŒä¸€ä¸ªæ—¶åˆ»ï¼Œåšå¤šä»¶äº‹å„¿ï¼Œå¤šä¸ªcpuå¤„ç†å¤šä»¶äº‹æƒ…



ç¼–ç¨‹è§†è§’ï¼š

åŒæ­¥ï¼š ç­‰å¾…å‰ä¸€ä¸ªä»»åŠ¡ç»“æŸåï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œæ— å¹¶å‘æˆ–è€…å¹¶è¡Œæ¦‚å¿µ

å¼‚æ­¥ï¼š å¤šä¸ªä»»åŠ¡ï¼ŒåŒæ—¶æ‰§è¡Œï¼Œå¹¶å‘ & å¹¶è¡Œ

![æˆªå±2024-10-12 ä¸Šåˆ10.42.28](/Users/joy/Library/Application Support/typora-user-images/æˆªå±2024-10-12 ä¸Šåˆ10.42.28.png)





å¤šçº¿ç¨‹åŒæ­¥ï¼š å½“æœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹å†…å­˜æŸä¸€å—åœ°å€æ“ä½œçš„æ—¶å€™ï¼Œä¸å…è®¸å…¶ä»–çº¿ç¨‹å¯¹è¿™ä¸ªå†…å­˜åœ°å€è¿›è¡Œæ“ä½œï¼Œç›´åˆ°è¯¥çº¿ç¨‹æ“ä½œå®Œæˆ

åº”ç”¨ï¼šåœ¨ä½¿ç”¨å¤šçº¿ç¨‹è¿›è¡Œå¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œä¸€äº›æ•æ„Ÿé‡è¦çš„æ•°æ®ä¸å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼Œæ­¤æ—¶å°±éœ€è¦å¤šçº¿ç¨‹åŒæ­¥æŠ€æœ¯ï¼Œä¿è¯æ•°æ®åœ¨ä»»ä½•æ—¶åˆ»ï¼Œæœ€å¤šæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®ã€‚



```C#
namespace demo115
{
   internal class Program
   {
     //å¯è§æ€§å’Œæœ‰åºæ€§
     //volatile cpuå°±ä¸å»æ“ä½œå¯„å­˜å™¨äº†ï¼Œç›´æ¥å»æ“ä½œå†…å­˜äº†ï¼Œä½†å¦‚æœç¬¬ä¸€ä¸ªçº¿ç¨‹åªæ˜¯+1äº†ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æŠŠå€¼å­˜å…¥å†…å­˜çš„è¯ï¼Œé‚£ç¬¬äºŒä¸ªçº¿ç¨‹æ‹¿åˆ°çš„æ—¶å€™è¿˜æ˜¯ä¹‹å‰çš„å€¼ï¼Œä¹Ÿä¸æ˜¯æœ€æ–°çš„å€¼ï¼Œä½†æ˜¯ä¿è¯äº†ç›´æ¥å­˜å…¥å†…å­˜ï¼Œä½†æ˜¯åŸå­æ€§æ— æ³•ä¿è¯ï¼Œæ‰€ä»¥è¦æ€ä¹ˆä¿è¯åŸå­æ€§å‘¢ï¼Ÿ
      
       private static volatile int Count = 0;
       private static object o = new object();
       static void Main(string[] args)
       {
         
          Thread th = new Thread(()=>{
             for(int i = 0; i< 10000; i++)
             {
               //ä¸ºäº†ä¿è¯åŸå­æ€§
               //åŠ äº†é”ä¹‹åå°±æ˜¯ çº¿ç¨‹1 è¿›æ¥ç„¶åæ›´æ”¹Countçš„æ•°å­—ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯é”ä½å†…å­˜çš„ï¼Œç­‰çº¿ç¨‹1æ‰§è¡Œå®Œäº†ï¼Œå†æŠŠé”çš„é’¥åŒ™ç»™äº†çº¿ç¨‹2ï¼Œè¿™æ ·çº¿ç¨‹2æ‰èƒ½æ‰§è¡Œï¼Œçº¿ç¨‹2æ‰§è¡Œçš„æ—¶å€™ğŸ”’åˆä¸Šäº†ï¼Œæ‰€ä»¥çº¿ç¨‹1åªèƒ½åœ¨é—¨å£æ’é˜Ÿ
               Monitor.Enter(o);
               Count++;
               Monitor.Exit(o);
               //å»å†…å­˜å™¨ä¸­è¯»å–Countçš„å€¼
               //åœ¨å¯„å­˜å™¨ä¸­ç»™COuntçš„å€¼+1
               //æŠŠæ”¹å˜åçš„å€¼å­˜å…¥å†…å­˜
               
               //Il ä¸­é—´ä»£ç  ---ã€‹ äºŒè¿›åˆ¶ æœ‰åºæ€§
             }
          });
          Thread t2 = new Thread(() => {
             for(int i = 0; i < 10000; i++)
             {
               lock(o)
               {
                   Count++;
               }
             }
          });
          t1.Start();
          t2.Start();
          Thread.Sleep(4000);
          Console.WriteLine(Count);
       }
   }
}
```

//å½“å‰åœ¨å†…å­˜é‡Œæœ‰ä¸ªå€¼ï¼Œcount = 0

![æˆªå±2024-10-12 ä¸Šåˆ10.53.00](/Users/joy/Library/Application Support/typora-user-images/æˆªå±2024-10-12 ä¸Šåˆ10.53.00.png)

cpuå†…å­˜å™¨



1.çº¿ç¨‹1ï¼Œå»å†…å­˜ä¸­è¯»å–æ•°æ®ï¼Œä¼šè¯»åˆ°Count = 0ï¼Œå¹¶æŠŠCount = 0 ä¿å­˜åœ¨å†…å­˜é‡Œé¢

2.åœ¨cpuå¯„å­˜å™¨ï¼Œæ‰§è¡Œcount++ï¼Œæ‰§è¡Œå®Œæˆä¹‹å

3.å°†æ”¹å˜åçš„å€¼é‡æ–°å†™å…¥åˆ°å†…å­˜ä¸­



### å¹¶å‘ç¼–ç¨‹çš„ä¸‰å¤§ç‰¹å¾

å¯è§æ€§ï¼š å½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®ä¸€ä¸ªå˜é‡å¹¶ä¸”ä¿®æ”¹çš„æ—¶å€™ å…¶ä»–çº¿ç¨‹èƒ½çœ‹åˆ°ä¿®æ”¹åçš„å€¼

åŸå­æ€§ï¼šä¸€æ¬¡æ“ä½œæˆ–è€…å¤šä¸ªæ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œ è¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œ ä¸è¢«ä»»ä½•å€¼æ‰“æ–­

æœ‰åºæ€§ï¼š ç¨‹åºæŒ‰ç…§é¡ºåºå»æ‰§è¡Œ



### Volatileå’Œäº’æ–¥é”

volatileï¼Œåœ¨ç±»å‰é¢åŠ  å°±æ˜¯å‘Šè¯‰cpuä¸å†å»ç¨‹åºè®¡æ­¥å™¨é‡Œé¢ è€Œæ˜¯å»æ“ä½œç¨‹åºå†…å­˜

ä»–åªä¿éšœäº†å¯è§æ€§å’Œæœ‰åºæ€§ ä½†æ˜¯æ²¡æœ‰ä¿éšœåŸå­æ€§

Monitor .enter(). è¿›å…¥é” äº’æ–¥é”

Monitor.end() è§£å¼€é”

lock



### Interlockå’ŒSynchronised



```C#
namespace demo115
{
   internal class Program
   {
     //å¯è§æ€§å’Œæœ‰åºæ€§
     //volatile cpuå°±ä¸å»æ“ä½œå¯„å­˜å™¨äº†ï¼Œç›´æ¥å»æ“ä½œå†…å­˜äº†ï¼Œä½†å¦‚æœç¬¬ä¸€ä¸ªçº¿ç¨‹åªæ˜¯+1äº†ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æŠŠå€¼å­˜å…¥å†…å­˜çš„è¯ï¼Œé‚£ç¬¬äºŒä¸ªçº¿ç¨‹æ‹¿åˆ°çš„æ—¶å€™è¿˜æ˜¯ä¹‹å‰çš„å€¼ï¼Œä¹Ÿä¸æ˜¯æœ€æ–°çš„å€¼ï¼Œä½†æ˜¯ä¿è¯äº†ç›´æ¥å­˜å…¥å†…å­˜ï¼Œä½†æ˜¯åŸå­æ€§æ— æ³•ä¿è¯ï¼Œæ‰€ä»¥è¦æ€ä¹ˆä¿è¯åŸå­æ€§å‘¢ï¼Ÿ
      
       private static int Count = 0;
       private static object o = new object();
       static void Main(string[] args)
       {
         
          Thread th = new Thread(()=>{
             for(int i = 0; i< 10000; i++)
             {
                Interlocked.Increment(ref Count);
               //interlockedå’Œé”æ˜¯ä¸€ä¸ªåŸç†ï¼Œé‡Œé¢è¦ä¼ å…¥å“ªä¸ªè¦åŸå­æ€§çš„æ•°æ®ï¼Œrefå˜é‡,è¿™ä¸ªåªèƒ½é”ä¸€ä¸ªå˜é‡
               //ä½†å¦‚æœæˆ‘ä»¬æƒ³é”ä¸€ä¸ªæ–¹æ³•çš„è¯ï¼Œéœ€è¦æ€ä¹ˆåŠæ
               //é”æ–¹æ³• 
               //åŠ æ³¨è§£[mtehodimploptions.synchronized]
             }
          });
          Thread t2 = new Thread(() => {
             for(int i = 0; i < 10000; i++)
             {
               lock(o)
               {
                   Interlocked.Increment(ref Count);
               }
             }
          });
          t1.Start();
          t2.Start();
          Thread.Sleep(4000);
          Console.WriteLine(Count);
       }
   }
}
```





```C#
namespace demo115
{
   internal class Program
   {
     //å¯è§æ€§å’Œæœ‰åºæ€§
     //volatile cpuå°±ä¸å»æ“ä½œå¯„å­˜å™¨äº†ï¼Œç›´æ¥å»æ“ä½œå†…å­˜äº†ï¼Œä½†å¦‚æœç¬¬ä¸€ä¸ªçº¿ç¨‹åªæ˜¯+1äº†ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æŠŠå€¼å­˜å…¥å†…å­˜çš„è¯ï¼Œé‚£ç¬¬äºŒä¸ªçº¿ç¨‹æ‹¿åˆ°çš„æ—¶å€™è¿˜æ˜¯ä¹‹å‰çš„å€¼ï¼Œä¹Ÿä¸æ˜¯æœ€æ–°çš„å€¼ï¼Œä½†æ˜¯ä¿è¯äº†ç›´æ¥å­˜å…¥å†…å­˜ï¼Œä½†æ˜¯åŸå­æ€§æ— æ³•ä¿è¯ï¼Œæ‰€ä»¥è¦æ€ä¹ˆä¿è¯åŸå­æ€§å‘¢ï¼Ÿ
      
       private static volative int Count = 0;
       static void Main(string[] args)
       {
          new Thread(T1).Start();
          new Thread(T2).Start();
          Thread.Sleep(4000);
          Console.WriteLine(Count); //10000
       }
     //åªè¦æ‰“ä¸Šè¿™ä¸ªæ³¨è§£ï¼Œå°±è¢«é”ä½å•¦
       [MethodImpl(MethodImplOptions.Synchronized)]
       public static void T1()
       {
         for(int i = 0; i < 10000; i++)
         {
            Count++;
         }
       }
   }
}
```





### æ­»é”

äº’ç›¸å ç”¨èµ„æºä¸ç»™åˆ«äºº

æ•¬ä¸šç¦ çˆ±å›½ç¦



æ­»é”

äº’æ–¥æ€§ï¼š å½“ä¸€ä¸ªèµ„æºè¢«çº¿ç¨‹ä½¿ç”¨çš„æ—¶å€™ï¼Œåˆ«çš„çº¿ç¨‹ä¸èƒ½ä½¿ç”¨ //å‰å‡ ç« éƒ½è¯´æ˜äº†äº’æ–¥æ€§

ä¸å¯æŠ¢å æ€§ï¼š èµ„æºè¯·æ±‚è€…ä¸å¯å¼ºåˆ¶ä»èµ„æºæ‹¥æœ‰è€…ä¸­æŠ¢å¤ºèµ„æº 

å æœ‰åˆ‡ç­‰å¾…æ€§ï¼š èµ„æºè¯·æ±‚è€…åœ¨ç­‰å¾…å…¶ä»–èµ„æºæ—¶å€™ï¼Œä¿æŒåŸæœ‰èµ„æºçš„å ç”¨ 

å¾ªç¯ç­‰å¾…æ€§ï¼š çº¿ç¨‹1 ç­‰å¾…çº¿ç¨‹2å æœ‰çš„èµ„æºï¼Œçº¿ç¨‹2ç­‰å¾…çº¿ç¨‹1å æœ‰çš„èµ„æº





æ­»é”çš„ç‰¹æ€§

```C#
//ä»£ç æ¨¡æ‹Ÿæ­»é”
namespace demo117æ­»é”
{
   internal class Program
   {
       private static object o1 = new object(); //æ•¬ä¸šç¦
       private static object o2 = new object(); //çˆ±å›½ç¦
       static void Main(string[] args)
       {
           //é›†2ç¦
           //æ•¬ä¸šç¦
           //çˆ±å›½ç¦
           //çº¿ç¨‹1 è¡¨ç¤ºç”·ç”Ÿ æ‹¿åˆ°äº†æ•¬ä¸šç¦ åœ¨ç­‰çˆ±å›½ç¦
         //å››ä¸ªç‰¹å¾ï¼Œå‰ä¸‰ä¸ªåŸºæœ¬ä¸èƒ½åŠ¨ï¼Œå› ä¸ºæˆ‘ä»¬çº¿ç¨‹åŒæ­¥éœ€è¦ä¿è¯ç»“æœçš„ç¨³å®šæ€§
         //æˆ‘ä»¬ç°åœ¨èƒ½åšçš„ å°±æ˜¯ç ´åç¬¬å››ä¸ªæ¡ä»¶ ä¹Ÿå°±æ˜¯éœ€è¦æˆ‘ä»¬çš„ç¨‹åºä¸­ä¸€å®šä¸è¦å‡ºç° å¾ªç¯ç­‰å¾…çš„é—®é¢˜
         //éœ€è¦ä½ åœ¨ç¨‹åºè®¾è®¡çš„åˆæœŸ æŠŠå¾ªç¯ç­‰å¾…çš„æ¡ä»¶ä»æ ¹æºä¸ŠæŠ¹é™¤
         //è¯­æ³•å±‚é¢ä¸Šå°½é‡é¿å…é”å¥—é”çš„é—®é¢˜ å‡ºç°äº†è¯ å¾ˆæœ‰å¯èƒ½å‡ºç°æ­»é”ï¼Œ æ”¹å˜çš„è¯ å°±æ˜¯ä¸Šé¢æ€ä¹ˆé”çš„ï¼Œä¸‹é¢å°±æ€ä¹ˆé”
           Thread th1 = (() => {
             lock(o1)
             {
                Console.WriteLine("ç”·ç”Ÿæ‹¿åˆ°äº†æ•¬ä¸šç¦");
                Console.WriteLine("ç”·ç”Ÿæƒ³è¦çˆ±å›½ç¦");
                Thread.Sleep(2000);
                lock(o2)
                {
                    //å¦‚æœè¾“å‡ºäº†è¿™å¥è¯ï¼Œä»£è¡¨æ‹¿åˆ°äº†çˆ±å›½ç¦
                   //æ³¨æ„è¿™å¥è¯æœ‰æ²¡æœ‰è¾“å‡º
                    Console.WriteLIne("ç”·ç”Ÿæ‹¿åˆ°äº†çˆ±å›½ç¦")
                }
             }
             //äº’æ–¥æ€§ï¼šo1è¢«ç¬¬ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œæ‰€ä»¥th2 æ‹¿ä¸åˆ°o1äº†ï¼Œ o2è¢«ç¬¬äºŒä¸ªèµ„æºä½¿ç”¨äº†ï¼Œæ‰€ä»¥th1æ‹¿ä¸åˆ°o2äº†
             //ä¸å¯æŠ¢å æ€§ï¼šèµ„æºè¯·æ±‚è€…ä¸å¯å¼ºåˆ¶ä»èµ„æºæ‹¥æœ‰è€…ä¸­æŠ¢å¤ºèµ„æº
             //å æœ‰åˆ‡ç­‰å¾…æ€§ï¼šèµ„æºè¯·æ±‚è€…å¸¦ç­‰å¾…å…¶ä»–èµ„æºæ—¶ï¼Œä¿æŒåŸæœ‰èµ„æºçš„å æœ‰
             //å¾ªç¯ç­‰å¾…æ€§ï¼š çº¿ç¨‹1ç­‰å¾…çº¿ç¨‹2å æœ‰çš„èµ„æºï¼Œçº¿ç¨‹2ç­‰å¾…çº¿ç¨‹1å æœ‰çš„èµ„æº
           th1.Start();
           Thread th2 = (() => {
             lock(o1)
             {
                Console.WriteLine("å¥³ç”Ÿæ‹¿åˆ°äº†çˆ±å›½ç¦");
                Console.WriteLine("å¥³ç”Ÿæƒ³è¦æ•¬ä¸šç¦");
                Thread.Sleep(2000);
                lock(o2)
                {
                    //å¦‚æœè¾“å‡ºäº†è¿™å¥è¯ï¼Œä»£è¡¨æ‹¿åˆ°äº†çˆ±å›½ç¦
                   //æ³¨æ„è¿™å¥è¯æœ‰æ²¡æœ‰è¾“å‡º
                    Console.WriteLIne("å¥³ç”Ÿæ‹¿åˆ°äº†æ•¬ä¸šç¦")
                }
             }         
           });
            th2.Start();
           //çº¿ç¨‹2 è¡¨ç¤ºå¥³æ€§ æ‹¿åˆ°äº†çˆ±å›½ç¦ åœ¨ç­‰æ•¬ä¸šç¦
            Console.ReadKey();
       }
   }
}
```



å…ˆæ‰§è¡Œth1ï¼Œç„¶åth1ç¡çœ ä¸¤ç§’ï¼Œç¡çœ çš„æ—¶å€™ï¼ŒcpuæŠŠæ‰§è¡Œæƒç»™äº†th2ï¼Œè¾“å‡ºä¸¤å¥è¯ï¼Œç„¶åcpuæŠŠæ‰§è¡Œæƒè¿˜ç»™äº†th1ï¼Œç„¶åå°±å›å»th1ï¼Œç­‰å¾…o2é‡Šæ”¾ï¼Œå› æ­¤ç¨‹åºå°±å¡æ­»äº†



å¼‚æ­¥ç¼–ç¨‹çš„æ¼”è¿›çš„å†å²

åŒæ­¥æ–¹æ³•ï¼š è°ƒç”¨è€…éœ€è¦ç­‰å¾…è¯¥æ–¹æ³•æ‰§è¡Œå®Œæ¯•å¹¶è¿”å›æ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œæˆ‘ä»¬ç§°è¿™ä¸ªæ–¹æ³•æ˜¯åŒæ­¥æ–¹æ³•ï¼›

å¼‚æ­¥æ–¹æ³•ï¼š å½“ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œç«‹å³è¿”å›ï¼Œå¹¶è·å–ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¯¥æ–¹æ³•å†…éƒ¨çš„ä¸šåŠ¡ï¼Œè°ƒç”¨è€…ä¸ç”¨ç­‰å¾…è¯¥æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œæˆ‘ä»¬æˆä¸ºè¿™ä¸ªæ–¹æ³•ä¸ºå¼‚æ­¥æ–¹æ³•ã€‚å¼‚æ­¥çš„å¥½å¤„åœ¨äºéé˜»å¡ï¼ˆè°ƒç”¨çº¿ç¨‹ä¸ä¼šæš‚åœæ‰§è¡Œå»ç­‰å¾…å­çº¿ç¨‹çš„å®Œæˆï¼‰ï¼Œ

å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸€äº›ä¸éœ€è¦ç«‹å³ä½¿ç”¨ç»“æœï¼Œè¾ƒä¸ºè€—æ—¶çš„ä»»åŠ¡è®¾ä¸ºå¼‚æ­¥æ‰§è¡Œï¼Œå¯ä»¥æé«˜ç¨‹åºçš„è¿è¡Œæ•ˆç‡ã€‚

C# 4.0åœ¨ThreadPoolçš„åŸºç¡€ä¸Šæ¨å‡ºäº†Taskç±»ï¼Œç°åœ¨C#ç±»åº“ä¸­çš„å¼‚æ­¥æ–¹æ³•åŸºæœ¬éƒ½ç”¨åˆ°äº†Taskï¼Œ C#5.0æ¨å‡ºäº†async/awaitï¼Œè®©å¼‚æ­¥ç¼–ç¨‹æ›´ä¸ºæ–¹ä¾¿





*EAPåŸºäºäº‹ä»¶çš„å¼‚æ­¥æ¨¡å‹ åŸºæœ¬ä¸ç”¨å•¦ ä½†è¦äº†è§£

ä¼˜ç‚¹ï¼š ä½¿ç”¨ç®€å•

ç¼ºç‚¹ï¼š ä¸å¥½å¤„ç†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼ŒC#æ”¯æŒçš„ç›¸å…³æ¨¡å‹ä¸å¤š



```C#
using System.Net;

namespace demo118EAPå¼‚æ­¥ç¼–ç¨‹
{
   internal class Program
   {
      static void Main(string[] args)
      {
          WebClient webClient = new WebClient();
        //DownloadString åŒæ­¥æ–¹æ³•ï¼Œè¿™ä¸ªäº‹æƒ…ä¸åšå®Œï¼Œå°±æ— æ³•å»åšå…¶ä»–çš„äº‹æƒ…
          string str = webClient.DownloadString("https://luffycity.com/actual-course/612");
          Console.WriteLine("å“ˆå“ˆå“ˆ");
          Console.WriteLine(str);
        
        //é€šè¿‡EAPæ¥å®ç°å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹
        
        //ä¸‹è½½å‰ æ³¨å†Œä¸€ä¸ªä¸‹è½½ç»“æŸåçš„äº‹ä»¶ å½“äº‹ä»¶è¢«è§¦å‘çš„æ—¶å€™ å°±è¯´æ˜æˆ‘ä»¬çš„ä¸‹è½½ä»»åŠ¡å·²ç»å®Œæˆäº†
        //Asyncå°±æ˜¯å¼‚æ­¥
        webClient.DownloadStringCompleted += WebClient_DownloadStringCompleted;
        webClient.DownloadStringAsync(new Uri("https://www.taobao.com"));
        Console.WriteLine("å“ˆå“ˆå“ˆå“ˆ");
        Console.ReadKey();
      }
      private static void WebClient_DownloadStringCompleted(object sender, DownloadStringCompletedEventArgs e)
      {
          Console.WriteLine(e.Result);
      }
   }
}
```







*APMåŸºäºå¼‚æ­¥æ¨¡å‹ åŸºæœ¬ä¸ç”¨å•¦ï¼Œ IAsyncResult, AsyncWaitHandle,ä¸€ä¸ªç”¨æ¥ç­‰å¾…å¼‚æ­¥ç»“æŸåçš„åŒæ­¥å¯¹è±¡

C# ä¸­æ”¯æŒçš„ç±»æ¯”è¾ƒå¤šï¼ŒSocketï¼ŒStreamç­‰

åœ¨TPLå‡ºç°ä¹‹å‰ç”¨çš„æœ€å¤šçš„æ¨¡å‹

APMæ”¯æŒçš„ç±»æ¯”è¾ƒå¤š



```C#
namespace demo119APM
{
   internal class Program
   {
      static void Main(string[] args)
      {
          //é€šè¿‡æ–‡ä»¶æ¥è¯»å–
          string path = @"/Users/joy/Documents/GitHub/study-notes/a.txt";
          string s = null;
          ThreadPool.QueueUserWorkItem((x) => {
              using (FileStream fsRead = new FileStream(path, FileMode.Open, FileAccess.Read))
              {
                 byte[] Buffer = new byte[1024*1024*2];
                 //Readæ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³• ä¼šé˜»å¡æˆ‘ä»¬çº¿ç¨‹çš„è¿è¡Œ
                 //APMå¼‚æ­¥æ¨¡å‹ ä¸€èˆ¬éƒ½ä»¥Begin/***å¼€å§‹ï¼Œ Endxxxç»“æŸ
                 //BeginRead: åªæ˜¯å‡†å¤‡è¯»å–æ•°æ®ï¼Œä½†æ˜¯æ²¡æœ‰ç›´æ¥å»æ‰§è¡Œ
                 IAsyncResult asyncResult = fsRead.BeginRead(buffer, 0, buffer.Length, null, null);
                //ä¸æ˜¯å¼‚æ­¥çš„ä¸œè¥¿
                //è°ƒç”¨waitoneæ–¹æ³•è¿›è¡Œç­‰å¾…ï¼Œ çŸ¥é“æ•°æ®è¯»å–å®Œæˆ
                 asyncResult.AsyncWaitHandle.WaitOne();

                 s = Encoding.Default.GetString(buffer);
                 fsRead.EndRead(asyncResult);
              }
          }, null);
         Thread.Sleep(1000);//ä¸»çº¿ç¨‹ç¡ä¸€ä¼šå„¿ å°±èƒ½è¯»åˆ°äº†
         Console.WriteLine(s);
      }
   }
}
```





TPLï¼šåŸºäºäº‹ä»¶çš„å¼‚æ­¥æ¨¡å‹Task

å¤šçº¿ç¨‹é—®é¢˜ï¼š ç¼–å†™ç¹çï¼Œå¤šçº¿ç¨‹åŒæ­¥é—®é¢˜ï¼ŒæŠ¢å èµ„æºé—®é¢˜ï¼Œè°ƒåº¦é—®é¢˜ï¼ŒåŒæ­¥é—®é¢˜ï¼Œæ­»é”é—®é¢˜ï¼Œæµªè´¹èµ„æºã€‚ã€‚ã€‚

çº¿ç¨‹æ± ï¼šçº¿ç¨‹çš„æŠ½è±¡å°è£…ã€‚æ“ä½œç®€å•ã€èŠ‚çœèµ„æºã€‚é—®é¢˜ï¼šè·å–çº¿ç¨‹æ‰§è¡Œç»“æœï¼Œç›¸å…³çš„è¿ç»­çš„å¼‚æ­¥æ“ä½œï¼Œå¾ˆå¤æ‚

çº¿ç¨‹æ± ï¼šçº¿ç¨‹çš„æŠ½è±¡å°è£… æ“ä½œç®€å•ï¼ŒèŠ‚çœèµ„æº

å‘æŒ¥å¤šæ ¸CPUçš„åŠŸæ•ˆï¼Œæå‡ç¨‹åºæ•´ä½“çš„è¿è¡Œæ€§èƒ½ï¼Œä¸éœ€è¦ç¼–å†™åº•å±‚å¤æ‚åˆ‡é€»è¾‘å¤æ‚çš„å¤šçº¿ç¨‹ä»£ç 





### Task async await



Task 

ç±»Taskè¡¨ç¤ºä¸€ä¸ªä¸è¿”å›å€¼åˆ‡é€šå¸¸å¼‚æ­¥æ‰§è¡Œçš„å•ä¸ªæ“ä½œï¼ŒTaskå¯¹è±¡æ˜¯é¦–å…ˆåœ¨.NET Framework4ä¸­å¼•å…¥çš„æœºé‡ä»»åŠ¡çš„å¼‚æ­¥æ¨¡å‹çš„ä¸­å¿ƒç»„å»ºä¹‹ä¸€ï¼Œç”±äºå¯¹è±¡æ‰§è¡ŒTaskçš„å·¥ä½œé€šå¸¸ä»¥å¼‚æ­¥æ–¹å¼åœ¨çº¿ç¨‹æ± çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œè€Œä¸æ˜¯åœ¨ä¸»åº”ç”¨ç¨‹åºçº¿ç¨‹ä¸ŠåŒæ­¥æ‰§è¡Œï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨statuså±æ€§ä»¥åŠå±æ€§IsCanceledIsCompletedå’ŒIsFaultedå±æ€§æ¥ç¡®å®šä»»åŠ¡çš„çŠ¶æ€ã€‚é€šå¸¸ï¼ŒLambdaè¡¨è¾¾å¼ç”¨äºæŒ‡å®šä»»åŠ¡è¦æ‰§è¡Œçš„å·¥ä½œ

å¯¹äºè¿”å›å€¼çš„æ“ä½œï¼Œè¯·ä½¿ç”¨Taskè¯¥ç±»



```C#
namespace demo120Task
{
   internal class Program
   {
       static void Main(string[] args)
       {
         //ç»“è®ºï¼š ä»»åŠ¡æ˜¯è¢«çº¿ç¨‹æ± æ‰§è¡Œçš„ è™½ç„¶æˆ‘ä»¬æ²¡æœ‰æ‰‹åŠ¨å¼€å¯çº¿ç¨‹ ä½†æ˜¯ä¹Ÿè¢«æˆ‘ä»¬çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ‰§è¡Œ æˆ‘ä»¬çš„ä»»åŠ¡å°è£…äº†çº¿ç¨‹ç›¸å…³çš„æ“ä½œ
          Console.WriteLine($"ä»»åŠ¡ä¸»çº¿ç¨‹, æ‰§è¡Œçš„çº¿ç¨‹æ˜¯{Thread.CurrentThread.ManagedThreadId}, é‡Šæ”¾çš„æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹{Thread.CurrentThread.isThreadPoolThread}");
          Task task = new Task(() => Test("çº¿ç¨‹1"));
          //2.æ³¨æ„ã€‚æˆ‘ä»¬å¦‚æœä»¥åˆ›å»ºå¯¹è±¡çš„å½¢å¼æ¥åˆ›å»ºä»»åŠ¡ï¼Œéœ€è¦è°ƒç”¨startæ–¹æ³•ï¼Œæ‰‹åŠ¨æ‰§è¡Œä»»åŠ¡
          task.Start();
         
         //2ï¼Œé€šè¿‡é™æ€æ–¹æ³•æ¥Runä¹‹é—´æ‰§è¡Œçº¿ç¨‹
          Task.Run(()=>Test("çº¿ç¨‹2"));
         
         //3.é€šè¿‡å·¥å‚æ¥åˆ›å»ºä»»åŠ¡
         //é€šè¿‡Factoryåˆ›å»ºä»»åŠ¡ ä¹Ÿä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨Startæ–¹æ³•
          Task.Factory.StartNew(() => Test("çº¿ç¨‹3"));
         
       }
     public static void Test(string taskName)
     {
        Console.WriteLine($"ä»»åŠ¡{taskName}, æ‰§è¡Œçš„çº¿ç¨‹æ˜¯{Thread.CurrentThread.ManagedThreadId}, é‡Šæ”¾çš„æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹{Thread.CurrentThread.isThreadPoolThread}");
     }
   }
}

//ä»»åŠ¡ä¸»çº¿ç¨‹ï¼Œæ‰§è¡Œçš„çº¿ç¨‹ä¸º1ï¼Œé‡Šæ”¾çš„æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹False
//ä»»åŠ¡çº¿ç¨‹1ï¼Œæ‰§è¡Œçš„çº¿ç¨‹ä¸º8ï¼Œé‡Šæ”¾çš„æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹True
```



çº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„ä¸ªæ•° æ˜¯ç”±cpuçš„æ ¸æ•°æ¥å†³å®šçš„ ï¼Œä»»åŠ¡åœ¨çº¿ç¨‹æ± å¤–é¢æ’é˜Ÿï¼Œç”±cpuæ¥è°ƒåº¦çº¿ç¨‹è¿›è¡Œ



### taskæ‹¿åˆ°ä»»åŠ¡æ‰§è¡Œåçš„ç»“æœ

åŒæ­¥æ‰§è¡Œä»»åŠ¡

```C#
namespace demo120Task
{
   internal class Program
   {
       static void Main(string[] args)
       {
         //è·å–ä»»åŠ¡æ‰§è¡Œåçš„ç»“æœ
         //éœ€è¦ ç”¨åˆ°Taskæ³›å‹
         Task<int> task1 = new Task<int>(()=>Test("çº¿ç¨‹2"));
         //åŒæ­¥çš„è°ƒåº¦ä»»åŠ¡æ‰§è¡Œ çº¿ç¨‹falseï¼Œä¸»çº¿ç¨‹ åœ¨ä¸»çº¿ç¨‹ä¸­åŒæ­¥æ‰§è¡Œ
         //å¦‚æœå¾ˆå°çš„ä»£ç é‡ å¯ä»¥å»åŒæ­¥æ‰§è¡Œ
         //ä¿è¯ç»“æœçš„ç¨³å®šæ€§
         //ä¿è¯è¿è¡Œçš„æ•ˆç‡ï¼Œæ²¡æœ‰å¿…è¦å†å»è®©cpuè°ƒä¸€ä¸ªçº¿ç¨‹
         task1.RunSynchronously();
         //task.Start();
         //startä¹‹å,å¯ä»¥é€šè¿‡resultå±æ€§ï¼Œæ‹¿åˆ°ä»»åŠ¡æ‰§è¡Œåçš„ç»“æœ
         int result = task.Result;
         Console.WriteLine(result);
         Console.WriteLien("--------");
         
         
       }
     public static int Test(string taskName)
     {
        Console.WriteLine($"ä»»åŠ¡{taskName}, æ‰§è¡Œçš„çº¿ç¨‹æ˜¯{Thread.CurrentThread.ManagedThreadId}, é‡Šæ”¾çš„æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹{Thread.CurrentThread.isThreadPoolThread}");
     }
   }
}

//ä»»åŠ¡ä¸»çº¿ç¨‹ï¼Œæ‰§è¡Œçš„çº¿ç¨‹ä¸º1ï¼Œé‡Šæ”¾çš„æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹False
//ä»»åŠ¡çº¿ç¨‹1ï¼Œæ‰§è¡Œçš„çº¿ç¨‹ä¸º8ï¼Œé‡Šæ”¾çš„æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹True
```



### æ§åˆ¶çº¿ç¨‹çš„æ‰§è¡Œé¡ºåº

```C#
namespace demo
{
   internal class Program
   {
      static void Main(string[] args)
      {
         Task task1 = new Task(() => {
            Console.WriteLine("æˆ‘æ˜¯task1")ï¼›
            Thread.Delay(2000); //delayå¼‚æ­¥ç¡çœ 
            Console.WriteLine("task1æ‰§è¡Œå®Œæˆ");
         });
        Task task2 = new Task(() => {
           Console.WriteLine("æˆ‘æ˜¯task2");
           Thread.Sleep(2000);
           Task.Delay(1000);
           Console.WriteLine("task2æ‰§è¡Œå®Œæˆ");
        });
        tast1.Start();
        //ç­‰å¾…ä¸Šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå¹¶ä¸”ä¼šå µå¡ä¸»çº¿ç¨‹
        task2.Start();
        //ç­‰å¾…æ‹¬å·ä¸­çš„æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ‰ä¼šå¾€ä¸‹æ‰§è¡Œ
        //Task.WaitAll(task1, task2);
        //éœ€æ±‚1: æˆ‘å°±æƒ³task1å…ˆæ‰§è¡Œï¼Œtask1æ‰§è¡Œå®Œæˆï¼Œå†æ‰§è¡Œtask2
        //2.ç­‰å¾…ä¸¤ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œå†æ‰§è¡Œå…¶ä»–ä»£ç 

        Console.ReadLine("ç­‰å¾…2ä¸ªä»»åŠ¡å®Œæˆå æ‰§è¡Œçš„ä»£ç ");
        
        //éœ€æ±‚3: åªè¦2ä¸ªä»»åŠ¡ï¼Œä»»æ„ä¸€ä¸ªæ‰§è¡Œç»“æŸä¹‹åå°±å¯ä»¥æ‰§è¡Œåé¢çš„ä»£ç 
        //Task.WaitAny(task1, task2)
        
        //éœ€æ±‚4: 3ä¸ªé¡µé¢ a---ã€‹ b----ã€‹ c---ã€‰
        task1.ContinueWith((param)=>task2.Start());
        task2.ContinueWith((param)=> {
          Console.WriteLine("æˆ‘æ˜¯ä»»åŠ¡ä¸‰");
        });
      }
   }
}
```





### async and await

å¼‚æ­¥ç¼–ç¨‹ asyncå’Œawait

```C#
namespace demo123asyncAwait
{
    internal class Program
    {
        static void Main(string[] args)
        {
           SyncMethod();
           asyncMethodNoWait();
           asyncMethodWithWait();
           Console.WriteLine("ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæˆ");
          
           Console.ReadKey();
        }
        public static void SyncMethod()
        {
            Console.WriteLine("SyncMethodå¼€å§‹æ‰§è¡Œ");
            Thread.Sleep(5000);
            Console.WriteLine("SyncMethodhæ‰§è¡Œå®Œæˆ");
        }
        public static async void asyncMethodNoWait()
        {
            Console.WriteLine("asyncMethodNoWaitå¼€å§‹æ‰§è¡Œ");
          //æ ‡è®°äº†asyncçš„æ–¹æ³•å¦‚æœä¸å†™awaitå°±he
            Thread.Sleep(5000); //åŒæ­¥ç­‰å¾… ä¸åˆ›å»ºä»»åŠ¡
            Console.WriteLine("asyncMethodNoWaitæ‰§è¡Œå®Œæˆ");
        }
        public static async void asyncMethodWithWait()
        {
            Console.WriteLine("asyncMethodNoWaitå¼€å§‹æ‰§è¡Œ");
            await Task.Delay(5000); //å¼‚æ­¥ç­‰å¾… åˆ›å»ºä»»åŠ¡æ¥å®ç°ï¼Œè®©å­çº¿ç¨‹ç­‰å¾…ï¼Œæ‰€ä»¥å…ˆè¾“å‡ºçš„æ˜¯â€œä¸»çº¿ç¨‹æ‰§è¡Œå®Œæˆâ€
            Console.WriteLine("asyncMethodWithWaitæ‰§è¡Œå®Œæˆ");
        }
      //1.å¼‚æ­¥æ–¹æ³• å¦‚æœæ²¡æœ‰awaitå…³é”®å­—ï¼Œå…¶æ‰§è¡ŒåŸç†è¿˜æ˜¯åŒæ­¥è°ƒç”¨ ä¸»çº¿ç¨‹é‡åˆ°è€—æ—¶çš„æ“ä½œï¼Œä¾ç„¶ä¼šè¢«å µå¡
      //2.å¼‚æ­¥æ–¹æ³•å†è°ƒç”¨çš„æ—¶å€™ï¼Œåªæœ‰é‡åˆ°awaitæ‰ä¼šçœŸæ­£çš„å»å¼€å§‹å¼‚æ­¥ï¼Œè€Œä¸€èˆ¬å¼‚æ­¥çš„æ‰§è¡ŒåŸç†å°±æ˜¯ä¸€ä¸ªtaskå¯¹è±¡
      //awaitä¹‹åï¼Œä¸»çº¿ç¨‹å’Œå¼‚æ­¥çš„å­çº¿ç¨‹äº’ç›¸ä¸å½±å“ï¼Œå„è‡ªæ‰§è¡Œç›´åˆ°å…¨éƒ¨å®Œæˆ
    }
}
```





### awaitåº•å±‚åŸç†

```C#
namespace demo124awaitæ³¨æ„äº‹é¡¹
{
   internal class Program
   {
     //æ—©èµ·çš„ç‰ˆæœ¬ä¸­Mainå‡½æ•° ä¸å…è®¸è¢«æ ‡æ³¨async
     //ä½†æ˜¯åæ¥çš„ç‰ˆæœ¬å¯ç”¨æ ‡è®° asyncç”šè‡³è¿”å›å€¼ä¹Ÿå¯ä»¥æ ‡è®°ä¸ºTaskï¼Œä½†æ˜¯ä¸‹è½½ä¾ç„¶ä¸å…è®¸æ ‡è®°ä¸ºTask
      static async Task Main(string[] args)
      {
         WebClient webClinet = new WebClient();
        //await çš„è¿”å›ç»“æœ ï¼šstringç±»å‹
        //2.å¦‚æœæ–¹æ³•ä¸­å‡ºç°äº†awaitå…³é”®å­—ï¼Œè¿™awaitå…³é”®å­—æœ‰ä¸€ä¸ªç‰¹å¾ï¼šä¼ æŸ“æ€§
         //å¦‚æœç”¨asyncå’Œawaitæ‰€åœ¨çš„å‡½æ•°ä¸èƒ½ç”¨voidæ ‡è®°
        //taskæ ‡è®°ï¼Œæ²¡æœ‰è¿”å›å€¼ï¼Œä¹Ÿå°±æ˜¯ä¸éœ€è¦å’Œå…¶ä»–ä»»åŠ¡è¿›è¡Œäº¤äº’
        //Task<T>: å¦‚æœæœ‰è¿”å›å€¼ï¼Œåˆ™æ–¹æ³•ä¸­çš„è¿”å›å€¼çš„ç±»å‹ å°±æ˜¯Tçš„ç±»å‹
        //åœ¨winformä¸­ï¼Œå› ä¸ºæˆ‘ä»¬äº‹ä»¶å’Œå§”æ‰˜çš„å¯†åˆ‡çš„å…³ç³» å§”æ‰˜æ˜¯ç”±ä¸€ä¸ªæ˜ç¡®æ–¹æ³•çš„ç­¾åï¼Œåœ¨winformä¸­ å¼‚æ­¥æ–¹æ³• è¿”å›å€¼å¯ä»¥å†™void
        
         Task<string> s = webClient.DownloadStringTaskAsync("http://www.taobao.com");
         Console.WriteLine("ç­‰å¾…ä¸‹è½½");
         Console.WriteLine(s);
         Console.ReadKey();
      }
      public static async Task<string> AsyncTest()
      {
        
      }
   }
}
```

å¦‚æœConsole.WriteLine(s) æ”¾åœ¨å‰é¢ï¼Œè¾“å‡ºç»“æœç›¸åï¼Œå› ä¸ºè¢«å¡ä½äº†

åœ¨å¼‚æ­¥ç­‰å¾…çš„è¿‡ç¨‹ä¸­ï¼Œè¦å…ˆåšç¨‹åºè¦åšçš„äº‹æƒ…ï¼Œåšå®Œäº†ä¹‹åå†å»è¿”å›ç»“æœ





Threadä¸Taskçš„åŒºåˆ«ï¼ˆé¢è¯•ç‚¹ï¼‰

1.Taskæ˜¯åŸºäºThreadçš„ï¼Œæ˜¯æ¯”è¾ƒé«˜å±‚çº§çš„å°è£…ï¼ˆå¥¹æ˜¯åœ¨çº¿ç¨‹æ± çš„åŸºç¡€ä¹‹ä¸Šï¼‰ï¼ŒTaskæœ€ç»ˆè¿˜æ˜¯éœ€è¦threadæ¥æ‰§è¡Œ

Threadæ˜¯æ“ä½œç³»ç»Ÿçº§åˆ«çš„çº¿ç¨‹ï¼Œè€ŒTaskæ˜¯ä¸€ä¸ªé€»è¾‘å·¥ä½œå•å…ƒï¼Œæœ€ç»ˆä¹Ÿæ˜¯ç”±çº¿ç¨‹æ‰§è¡Œã€‚Taskä½¿å¾—å¼€å‘è€…ä¸éœ€è¦ç›´æ¥ç®¡ç†åº•å±‚çº¿ç¨‹ï¼Œè€Œå¯ä»¥æ›´åŠ æ³¨é‡ä»»åŠ¡æœ¬èº«

```C#
// ä½¿ç”¨Thread
Thread thread = new Thread(() => Console.WriteLine("Running in Thread"));
thread.Start();

// ä½¿ç”¨Task
Task task = Task.Run(() => Console.WriteLine("Running in Task"));

```

2.Taské»˜è®¤ä½¿ç”¨åå°çº¿ç¨‹æ‰§è¡Œï¼ŒThreadé»˜è®¤ä½¿ç”¨å‰å°çº¿ç¨‹

Taskä½¿ç”¨çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ï¼Œè€Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹é»˜è®¤ä¸ºåå°çº¿ç¨‹ï¼Œå½“æ‰€æœ‰å‰å°çº¿ç¨‹ç»“æŸåï¼Œåº”ç”¨ç¨‹åºä¼šè‡ªåŠ¨ä¸­æ­¢ï¼Œä¸ä¼šç­‰å¾…åå°çº¿ç¨‹ã€‚è€ŒThreadé»˜è®¤æ˜¯å‰å°çº¿ç¨‹ï¼Œåº”ç”¨ç¨‹åºä¼šç­‰å¾…æ‰€æœ‰å‰å°çº¿ç¨‹å®Œæ¯•åæ‰ä¼šç»“æŸ

```C#
// åˆ›å»ºåå°çº¿ç¨‹
Thread thread = new Thread(SomeMethod);
thread.IsBackground = true; // æ˜¾å¼è®¾ç½®ä¸ºåå°çº¿ç¨‹
thread.Start();
```



3.Taskå¯ä»¥æœ‰è¿”å›å€¼ï¼Œå¯ä»¥é€šè¿‡æ³›å‹(Task<TResult>)å¯ä»¥è¿”å›ä¸€ä¸ªå€¼ï¼ŒThreadæ²¡æœ‰è¿”å›å€¼ï¼Œè™½ç„¶Threadå¯ä»¥é€šè¿‡Startæ–¹æ³•å‚æ•°æ¥è¿›è¡Œè¿”å›å€¼å¤„ç†ï¼Œä½†æ˜¯ååˆ†ä¸ä¾¿

```C#
// Task with return value
Task<int> taskWithResult = Task.Run(() => {
    return 42;
});
int result = taskWithResult.Result; // 42

// Thread æ²¡æœ‰ç›´æ¥è¿”å›å€¼
```

4.Taskå¯ä»¥æ‰§è¡Œåç»­æ“ä½œï¼ŒThreadä¸èƒ½æ‰§è¡Œåç»­æ“ä½œ

Taskæä¾›äº†ContineWithçš„æ–¹æ³•ï¼Œå…è®¸åœ¨å½“å‰ä»»åŠ¡å®Œæˆåæ‰§è¡Œå¦å¤–çš„ä»»åŠ¡ï¼Œä»è€Œå®ç°ä»»åŠ¡çš„é“¾å¼æ‰§è¡Œã€‚è€ŒThreadæœ¬èº«ä¸æ”¯æŒè¿™ç§ä»»åŠ¡çš„é“¾å¼å¤„ç†æ–¹å¼

```C#
Task task = Task.Run(() => Console.WriteLine("First Task"))
    .ContinueWith(prevTask => Console.WriteLine("Second Task"));
```

5.Taskå¯ä»¥å–æ¶ˆä»»åŠ¡æ‰§è¡Œï¼ŒThreadä¸è¡Œ

**è§£é‡Š**ï¼š`Task` æä¾›äº†å–æ¶ˆæœºåˆ¶ï¼Œä½¿ç”¨ `CancellationToken` æ¥é€šçŸ¥ä»»åŠ¡å–æ¶ˆæ‰§è¡Œã€‚`Thread` æœ¬èº«æ²¡æœ‰å†…ç½®çš„å–æ¶ˆæœºåˆ¶ï¼Œé€šå¸¸åªèƒ½é€šè¿‡å…±äº«çŠ¶æ€å˜é‡æˆ–å…¶ä»–æ–¹å¼è¿›è¡Œå–æ¶ˆæ“ä½œã€‚

```C#
CancellationTokenSource cts = new CancellationTokenSource();
Task task = Task.Run(() => {
   while(!cts.Token.IsCancellationRequested) {
      //Task running
   }
}, cts.Token);
//Cancel the task
cts.Cancel();
```

6.å¼‚å¸¸ä¼ æ’­ï¼ŒThreadåœ¨çˆ¶æ–¹æ³•ä¸Šè·å–ä¸åˆ°å¼‚å¸¸ï¼Œè€Œtaskå¯ä»¥

**è§£é‡Š**ï¼š`Thread` å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œé™¤éæ‰‹åŠ¨æ•è·ï¼Œå¦åˆ™å¼‚å¸¸ä¸ä¼šä¼ æ’­åˆ°è°ƒç”¨æ–¹ï¼Œè€Œ `Task` çš„å¼‚å¸¸åˆ™ä¼šé€šè¿‡ `Task.Result` æˆ– `Task.Wait()` æŠ›å‡ºï¼Œå¯ä»¥åœ¨è°ƒç”¨æ–¹æ•è·å’Œå¤„ç†ã€‚

```C#
//Thread
try{
   Thread thread = new Thread(() => throw new Exception("Thread Exception"));
   thread.Start();
   thread.Join(); //è¿™é‡Œä¸ä¼šæ•è·åˆ°å¼‚å¸¸
} catch(Exception ex){
   Console.WriteLine("Exception caught"); //ä¸ä¼šæ•è·åˆ°
}

//Task
try{
   Task task = Task.Run(() => throw new Exception("Task exception"));
   task.Wait(); //è¿™é‡Œå¯ä»¥æ•è·å¼‚å¸¸
} catch(AggregateException ex) {
   Console.WriteLine("Exception caught" + ex.Message); //æ•è·åˆ°
}
```

**Task** æ˜¯æ›´é«˜çº§çš„æŠ½è±¡ï¼Œæä¾›äº†æ›´ä¸°å¯Œçš„åŠŸèƒ½ï¼Œå¦‚è¿”å›å€¼ã€é“¾å¼ä»»åŠ¡ã€å–æ¶ˆæœºåˆ¶ç­‰ã€‚

**Thread** æ˜¯åº•å±‚çš„å¹¶å‘å·¥å…·ï¼Œæ“ä½œçµæ´»ä½†ä¸å…·å¤‡é«˜å±‚æ¬¡çš„ç‰¹æ€§ï¼Œæ¯”å¦‚è¿”å›å€¼ã€å¼‚å¸¸ä¼ æ’­ç­‰ã€‚

**Task** æ›´é€‚åˆç°ä»£å¼‚æ­¥ç¼–ç¨‹å’Œéœ€è¦ä»»åŠ¡æ§åˆ¶çš„åœºæ™¯ï¼Œè€Œ **Thread** åœ¨éœ€è¦ç›´æ¥æ§åˆ¶çº¿ç¨‹çš„åœºæ™¯ä¸‹ä»ç„¶æœ‰ç”¨ã€‚